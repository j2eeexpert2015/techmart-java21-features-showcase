<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechMart - Payment Processing Demo | Java 21 Pattern Matching</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/payment-processing-demo.css">
</head>
<body>
<div class="container-fluid my-3">
    <div class="main-container">
        <!-- Header -->
        <header class="demo-header">
            <h1>
                <i class="fas fa-credit-card"></i>
                Payment Processing Demo
                <span class="java21-badge">Java 21</span>
            </h1>
            <p>Interactive demonstration of Java 21 Pattern Matching with Sealed Payment Hierarchy</p>
        </header>

        <!-- NEW: Demo Instructions Panel -->
        <div class="demo-instructions-panel">
            <div class="instructions-content">
                <h6><i class="fas fa-lightbulb"></i> Interactive Demo Guide</h6>
                <div class="instructions-steps">
                    <div class="instruction-step">
                        <span class="step-number">1</span>
                        <span class="step-text">Select payment method to see pattern matching</span>
                    </div>
                    <div class="instruction-step">
                        <span class="step-number">2</span>
                        <span class="step-text">Try different amounts to trigger guard conditions</span>
                    </div>
                    <div class="instruction-step">
                        <span class="step-number">3</span>
                        <span class="step-text">Change customer type to see tier-based logic</span>
                    </div>
                    <div class="instruction-step">
                        <span class="step-number">4</span>
                        <span class="step-text">Process payment to see Java 21 in action</span>
                    </div>
                </div>
                <div class="demo-hint">
                    <i class="fas fa-magic"></i>
                    <span>Watch the Visual Flow Inspector show real-time pattern matching decisions!</span>
                </div>
            </div>
        </div>

        <section class="demo-page-container p-3">
            <div class="row">
                <!-- Left Column: Payment Form -->
                <div class="col-lg-7">
                    <!-- Order Summary -->
                    <div class="demo-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-shopping-cart"></i> Order Summary</h5>
                            <div class="amount-test-buttons">
                                <small class="text-muted me-2">Test Amounts:</small>
                                <button class="btn btn-sm btn-outline-primary" onclick="setAmount(500)">
                                    $500 <small>Standard</small>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="setAmount(1500)">
                                    $1,500 <small>High Value</small>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="setAmount(6000)">
                                    $6,000 <small>Large Transfer</small>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="resetDemo()">
                                    <i class="fas fa-refresh"></i> Reset
                                </button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Sample TechMart Order</strong>
                                <div class="text-muted">Multiple items • Secure checkout</div>
                            </div>
                            <div class="text-end">
                                <strong class="fs-4 text-primary" id="order-total">$1,500.00</strong>
                                <div><small class="text-muted">Including tax & fees</small></div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="demo-card">
                        <h5><i class="fas fa-credit-card"></i> Select Payment Method</h5>
                        <p class="text-muted mb-3">Choose a payment method to see Java 21 pattern matching in action</p>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="payment-method-card selected" data-method="creditcard">
                                    <div class="mb-2">
                                        <i class="fab fa-cc-visa fa-2x text-primary"></i>
                                    </div>
                                    <h6>Credit Card</h6>
                                    <small class="text-muted">Visa, MasterCard, Amex</small>
                                    <div class="pattern-info">
                                        <strong>Pattern:</strong> CreditCard(number, type, cvv, ...)
                                    </div>
                                    <div class="pattern-info">
                                        <strong>Guards:</strong> amount > $1000, isInternational
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="payment-method-card" data-method="paypal">
                                    <div class="mb-2">
                                        <i class="fab fa-paypal fa-2x text-info"></i>
                                    </div>
                                    <h6>PayPal</h6>
                                    <small class="text-muted">PayPal account payments</small>
                                    <div class="pattern-info">
                                        <strong>Pattern:</strong> PayPal(email, accountId, ...)
                                    </div>
                                    <div class="pattern-info">
                                        <strong>Guards:</strong> isPremiumCustomer, isVerified
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="payment-method-card" data-method="banktransfer">
                                    <div class="mb-2">
                                        <i class="fas fa-university fa-2x text-success"></i>
                                    </div>
                                    <h6>Bank Transfer</h6>
                                    <small class="text-muted">ACH bank transfers</small>
                                    <div class="pattern-info">
                                        <strong>Pattern:</strong> BankTransfer(account, routing, ...)
                                    </div>
                                    <div class="pattern-info">
                                        <strong>Guards:</strong> amount >= $5000, validRouting
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Type Selector -->
                        <div class="customer-type-selector">
                            <h6><i class="fas fa-user"></i> Customer Type</h6>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="customerType" id="customer-basic" value="basic" checked>
                                <label class="btn btn-outline-secondary" for="customer-basic">
                                    <i class="fas fa-user"></i> Basic
                                </label>

                                <input type="radio" class="btn-check" name="customerType" id="customer-premium" value="premium">
                                <label class="btn btn-outline-primary" for="customer-premium">
                                    <i class="fas fa-star"></i> Premium
                                </label>

                                <input type="radio" class="btn-check" name="customerType" id="customer-vip" value="vip">
                                <label class="btn btn-outline-warning" for="customer-vip">
                                    <i class="fas fa-crown"></i> VIP
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Different customer tiers trigger different pattern matching logic and business rules
                            </small>
                        </div>

                        <!-- International Card Toggle -->
                        <div class="mt-3 p-3" style="background: rgba(6, 182, 212, 0.1); border-radius: 8px; border: 1px solid rgba(6, 182, 212, 0.2);">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="international-card">
                                <label class="form-check-label" for="international-card">
                                    <strong>International Card</strong>
                                    <div><small class="text-muted">Enables complex guard conditions for credit cards</small></div>
                                </label>
                            </div>
                        </div>

                        <!-- Demo Action Buttons -->
                        <div class="demo-action-buttons mt-4">
                            <button class="btn btn-primary-custom btn-lg" onclick="processPayment()">
                                <i class="fas fa-lock me-2"></i>
                                Process Payment - <span id="button-amount">$1,500.00</span>
                            </button>
                            <div class="mt-2 text-center">
                                <button class="btn btn-outline-info btn-sm me-2" onclick="showDemoScenarios()">
                                    <i class="fas fa-play"></i> Demo Scenarios
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showFlowHelp()">
                                    <i class="fas fa-question-circle"></i> Flow Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Pattern Matching Logic -->
                <div class="col-lg-5">
                    <!-- Java 21 API Reference -->
                    <div class="demo-card">
                        <h6><i class="fas fa-book"></i> Java 21 Pattern Matching Reference</h6>
                        <div class="api-help-text mb-2">
                            <small><i class="fas fa-info-circle"></i> Watch these patterns get highlighted as you interact with the demo</small>
                        </div>
                        <table class="table table-sm table-bordered api-reference-table mb-0">
                            <tbody>
                            <tr id="pattern-switch"><td><code>switch (payment)</code></td><td>Pattern matching switch expression</td></tr>
                            <tr id="pattern-creditcard"><td><code>case CreditCard(...)</code></td><td>Record pattern with destructuring</td></tr>
                            <tr id="pattern-guard"><td><code>when amount > 1000</code></td><td>Guard condition for business rules</td></tr>
                            <tr id="pattern-paypal"><td><code>case PayPal(...)</code></td><td>PayPal-specific pattern matching</td></tr>
                            <tr id="pattern-banktransfer"><td><code>case BankTransfer(...)</code></td><td>Bank transfer pattern routing</td></tr>
                            <tr id="pattern-sealed"><td><code>sealed interface</code></td><td>Exhaustive matching guarantee</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Processing Status -->
                    <div class="demo-card">
                        <h6><i class="fas fa-cogs"></i> Pattern Matching Status</h6>
                        <div class="processing-status" id="pattern-status">
                            <div class="status-step">
                                <div class="status-icon status-complete">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div>
                                    <div><strong>Payment Method</strong></div>
                                    <small class="text-muted">CreditCard pattern detected</small>
                                </div>
                            </div>
                            <div class="status-step">
                                <div class="status-icon status-active">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div>
                                    <div><strong>Guard Conditions</strong></div>
                                    <small class="text-muted">Amount > $1000 - verification required</small>
                                </div>
                            </div>
                            <div class="status-step">
                                <div class="status-icon status-pending">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <div><strong>Ready to Process</strong></div>
                                    <small class="text-muted">Click process to execute pattern matching</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Visual Flow Inspector -->
                    <div class="demo-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6><i class="fas fa-stream"></i> Visual Flow Inspector</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                        <div class="api-help-text mb-2">
                            <small><i class="fas fa-lightbulb"></i> Real-time visualization of Java 21 pattern matching execution</small>
                        </div>
                        <div id="api-log" class="api-log-container">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-mouse-pointer mb-2"></i><br>
                                Select payment method and amount to see pattern matching in action...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Demo Scenarios Modal -->
<div class="modal fade" id="scenariosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-play"></i> Automated Demo Scenarios</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Choose a scenario to automatically demonstrate Java 21 pattern matching features:</p>
                <div class="scenario-buttons d-grid gap-2">
                    <button class="btn btn-outline-warning text-start" onclick="runScenario('high-value-international')">
                        <strong>High-Value International Transaction</strong>
                        <small class="d-block">Credit card with complex guard conditions</small>
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="runScenario('premium-paypal')">
                        <strong>Premium Customer PayPal</strong>
                        <small class="d-block">Customer tier-based pattern matching</small>
                    </button>
                    <button class="btn btn-outline-success text-start" onclick="runScenario('large-bank-transfer')">
                        <strong>Large Bank Transfer</strong>
                        <small class="d-block">Amount-based approval workflow</small>
                    </button>
                    <button class="btn btn-outline-primary text-start" onclick="runScenario('all-patterns')">
                        <strong>Test All Patterns</strong>
                        <small class="d-block">Comprehensive pattern matching demo</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * Enhanced Payment Processing Demo JavaScript with Rich Visual Flow Inspector
     * Matches the sophistication of the shopping cart demo
     */

    // Enhanced demo configuration
    const PAYMENT_DEMO_CONFIG = {
        customerId: 1,
        baseUrl: '',
        originalAmount: 1500.00,
        orderAmount: 1500.00,
        highValueThreshold: 1000,
        largeTransferThreshold: 5000
    };

    // Enhanced demo state
    const PaymentDemoState = {
        selectedPaymentMethod: 'creditcard',
        customerType: 'basic',
        isInternational: false,
        instructionsVisible: true,
        tooltipsInitialized: false,
        scenarioRunning: false,
        demoStartTime: Date.now()
    };

    // Initialize enhanced demo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Enhanced Payment Processing Demo Initializing...');
        setupEventListeners();
        initializeTooltips();
        updatePatternMatching();
        setupUIGuidance();

        // Initial logging like shopping cart
        logAPIFlow('Demo Initialized', 'Java 21 Pattern Matching Demo ready', 'java21');
        logAPIFlow('Payment Method', 'CreditCard pattern selected by default', 'pattern');

        console.log('✅ Enhanced Payment Processing Demo Ready');
    });

    // Setup enhanced event listeners
    function setupEventListeners() {
        // Payment method selection
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.addEventListener('click', handlePaymentMethodSelection);
        });

        // Customer type change
        document.querySelectorAll('input[name="customerType"]').forEach(radio => {
            radio.addEventListener('change', handleCustomerTypeChange);
        });

        // International card toggle
        const internationalToggle = document.getElementById('international-card');
        if (internationalToggle) {
            internationalToggle.addEventListener('change', handleInternationalToggle);
        }
    }

    // Setup UI guidance
    function setupUIGuidance() {
        initializeTooltips();
    }

    // Initialize Bootstrap tooltips
    function initializeTooltips() {
        if (PaymentDemoState.tooltipsInitialized) return;

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        PaymentDemoState.tooltipsInitialized = true;
    }

    // Enhanced payment method selection
    function handlePaymentMethodSelection(event) {
        event.preventDefault();
        const card = event.currentTarget;
        const paymentMethod = card.getAttribute('data-method');

        if (paymentMethod === PaymentDemoState.selectedPaymentMethod) {
            return;
        }

        updateSelectedPaymentMethod(paymentMethod);
        updatePatternMatching();
        highlightPattern(paymentMethod);

        // Enhanced logging like shopping cart
        logAPIFlow('Payment Method Selection', `${getPatternName(paymentMethod)} pattern activated`, 'pattern');
        logAPIFlow('Pattern Preview', `switch(payment) → case ${getPatternName(paymentMethod)}(...)`, 'java21');

        showNotification(`Selected ${getPatternName(paymentMethod)} - Pattern matching updated`, 'info');
    }

    // Update selected payment method
    function updateSelectedPaymentMethod(paymentMethod) {
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.classList.remove('selected');
        });

        const selectedCard = document.querySelector(`[data-method="${paymentMethod}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        PaymentDemoState.selectedPaymentMethod = paymentMethod;
    }

    // Handle customer type changes
    function handleCustomerTypeChange(event) {
        const newCustomerType = event.target.value;
        PaymentDemoState.customerType = newCustomerType;

        updatePatternMatching();
        logAPIFlow('Customer Type Changed', `Now: ${newCustomerType.toUpperCase()}`, 'info');

        const tierMessages = {
            'basic': 'Basic customer - standard processing rates apply',
            'premium': 'Premium customer - reduced fees and priority support',
            'vip': 'VIP customer - expedited processing and no fees'
        };

        showNotification(tierMessages[newCustomerType], 'info');
    }

    // Handle international toggle
    function handleInternationalToggle(event) {
        PaymentDemoState.isInternational = event.target.checked;
        updatePatternMatching();

        logAPIFlow('International Status', PaymentDemoState.isInternational ? 'International Card' : 'Domestic Card', 'info');

        const message = PaymentDemoState.isInternational
            ? 'International card - additional fees may apply for high-value transactions'
            : 'Domestic card - standard processing applies';

        showNotification(message, 'info');
    }

    // Set amount with enhanced feedback
    function setAmount(amount) {
        const previousAmount = PAYMENT_DEMO_CONFIG.orderAmount;
        PAYMENT_DEMO_CONFIG.orderAmount = amount;

        updateAmountDisplays(amount);
        updatePatternMatching();

        logAPIFlow('Amount Updated', `Testing with $${amount.toLocaleString()}`, 'info');

        const guardAnalysis = analyzeGuardConditions();
        if (guardAnalysis.triggered) {
            logAPIFlow('Guard Preview', guardAnalysis.description, 'guard');
        }

        showNotification(`Testing with amount: $${amount.toLocaleString()} - Watch for guard condition changes!`, 'warning');
    }

    // Update amount displays
    function updateAmountDisplays(amount) {
        const totalElement = document.getElementById('order-total');
        const buttonAmountElement = document.getElementById('button-amount');

        if (totalElement) {
            totalElement.textContent = `$${amount.toLocaleString()}`;
        }
        if (buttonAmountElement) {
            buttonAmountElement.textContent = `$${amount.toLocaleString()}`;
        }
    }

    // Update pattern matching preview
    function updatePatternMatching() {
        const statusContainer = document.getElementById('pattern-status');
        const guardCondition = analyzeGuardConditions();

        let statusHtml = `
            <div class="status-step">
                <div class="status-icon status-complete">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <div><strong>Payment Method</strong></div>
                    <small class="text-muted">${getPatternName(PaymentDemoState.selectedPaymentMethod)} pattern detected</small>
                </div>
            </div>
        `;

        if (guardCondition.triggered) {
            statusHtml += `
                <div class="status-step status-highlighted">
                    <div class="status-icon status-active">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <div><strong>Guard Condition</strong></div>
                        <small class="text-muted">${guardCondition.description}</small>
                    </div>
                </div>
            `;
        } else {
            statusHtml += `
                <div class="status-step">
                    <div class="status-icon status-complete">
                        <i class="fas fa-check"></i>
                    </div>
                    <div>
                        <div><strong>Standard Processing</strong></div>
                        <small class="text-muted">No guard conditions triggered</small>
                    </div>
                </div>
            `;
        }

        statusHtml += `
            <div class="status-step">
                <div class="status-icon status-pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div>
                    <div><strong>Ready to Process</strong></div>
                    <small class="text-muted">Click process to execute pattern matching</small>
                </div>
            </div>
        `;

        statusContainer.innerHTML = statusHtml;
    }

    // Analyze guard conditions
    function analyzeGuardConditions() {
        const amount = PAYMENT_DEMO_CONFIG.orderAmount;
        const method = PaymentDemoState.selectedPaymentMethod;
        const customerType = PaymentDemoState.customerType;
        const isInternational = PaymentDemoState.isInternational;

        if (method === 'creditcard' && amount > 1000 && isInternational) {
            return {
                triggered: true,
                description: 'amount > $1000 && isInternational - verification required'
            };
        }
        if (method === 'creditcard' && amount > 1000) {
            return {
                triggered: true,
                description: 'amount > $1000 - enhanced security processing'
            };
        }
        if (method === 'paypal' && customerType !== 'basic') {
            return {
                triggered: true,
                description: 'isPremiumCustomer - expedited processing'
            };
        }
        if (method === 'banktransfer' && amount >= 5000) {
            return {
                triggered: true,
                description: 'amount >= $5000 - manager approval required'
            };
        }
        return { triggered: false, description: 'Standard processing' };
    }

    // Enhanced process payment with rich logging
    async function processPayment() {
        logAPIFlow('Payment Processing Started', 'Initiating backend request', 'info');
        logAPIFlow('Request Details', `Method: ${PaymentDemoState.selectedPaymentMethod}, Amount: $${PAYMENT_DEMO_CONFIG.orderAmount}, Customer: ${PaymentDemoState.customerType}`, 'info');

        try {
            const response = await fetch('/api/payment/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    paymentType: mapPaymentType(PaymentDemoState.selectedPaymentMethod),
                    amount: PAYMENT_DEMO_CONFIG.orderAmount,
                    customerTier: PaymentDemoState.customerType.toUpperCase(),
                    isInternational: PaymentDemoState.isInternational
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const result = await response.json();
            handleEnhancedPaymentResult(result);

        } catch (error) {
            console.error('Payment processing error:', error);
            logAPIFlow('❌ Backend Error', 'Could not connect to Spring Boot application', 'error');
            showNotification('Failed to connect to backend. Is the Java application running?', 'danger');
        }
    }

    // Handle enhanced payment result - LIKE SHOPPING CART
    function handleEnhancedPaymentResult(result) {
        console.log('Enhanced API response:', result);

        // === CONTROLLER & SERVICE METHOD TRACKING ===
        if (result.controller_method) {
            logAPIFlow('🔴 Controller', result.controller_method, 'controller');
        }
        if (result.service_method) {
            logAPIFlow('🟣 Service', result.service_method, 'service');
        }

        // === JAVA 21 FEATURES USED ===
        if (result.java21_features_used && result.java21_features_used.length > 0) {
            logAPIFlow('🔥 Java 21 Features', result.java21_features_used.join(', '), 'java21');
        }

        // === PATTERN MATCHING DETAILS ===
        if (result.pattern_matched) {
            logAPIFlow('🎯 Pattern Matched', result.pattern_matched, 'pattern');
        }
        if (result.guard_condition && result.guard_condition !== 'none') {
            logAPIFlow('⚡ Guard Condition', result.guard_condition, 'guard');
        }
        if (result.processing_action) {
            logAPIFlow('🔄 Processing Action', result.processing_action, 'action');
        }

        // === BUSINESS LOGIC & EDUCATIONAL INFO ===
        if (result.business_rule_applied) {
            logAPIFlow('📋 Business Rule', result.business_rule_applied, 'info');
        }
        if (result.pattern_matching_path) {
            logAPIFlow('🗺️ Pattern Path', result.pattern_matching_path, 'info');
        }

        // === FINAL RESULT ===
        logAPIFlow('✅ Processing Complete', `Status: ${result.status}`, 'success');

        const statusClass = result.successful ? 'success' :
                           result.requiresAdditionalAction ? 'warning' : 'danger';
        showNotification(`Payment ${result.status}: ${result.statusMessage || 'Processed'}`, statusClass);
    }

    // Enhanced API Flow Logger - LIKE SHOPPING CART
    function logAPIFlow(action, details, type = 'info') {
        const logContainer = document.getElementById('api-log');

        if (logContainer.querySelector('.text-muted')) {
            logContainer.innerHTML = '';
        }

        const logEntry = document.createElement('div');
        logEntry.className = 'api-flow-block';

        let iconColor = 'var(--info-color)';
        let specialTag = '';

        switch(type) {
            case 'java21':
                iconColor = 'var(--success-color)';
                specialTag = '<span class="java21-pattern-tag">Java 21</span>';
                break;
            case 'guard':
                iconColor = 'var(--warning-color)';
                specialTag = '<span class="java21-pattern-tag" style="background: var(--warning-color);">Guard</span>';
                break;
            case 'pattern':
                iconColor = 'var(--primary-color)';
                specialTag = '<span class="java21-pattern-tag" style="background: var(--primary-color);">Pattern</span>';
                break;
            case 'controller':
                iconColor = 'var(--danger-color)';
                break;
            case 'service':
                iconColor = 'var(--info-color)';
                break;
            case 'error':
                iconColor = 'var(--danger-color)';
                break;
            case 'success':
                iconColor = 'var(--success-color)';
                break;
        }

        let logHTML = `<div style="border-left-color: ${iconColor}"><strong>${action}</strong> ${specialTag}</div>`;
        logHTML += `<div class="api-flow-child">📋 ${details}</div>`;

        logEntry.innerHTML = logHTML;
        logContainer.insertBefore(logEntry, logContainer.firstChild);

        while (logContainer.children.length > 12) {
            logContainer.removeChild(logContainer.lastChild);
        }

        logContainer.scrollTop = 0;
    }

    // Highlight pattern in reference table
    function highlightPattern(method) {
        // Clear previous highlights
        document.querySelectorAll('.api-reference-table tr').forEach(row => {
            row.classList.remove('pattern-highlight');
        });

        // Highlight relevant patterns
        document.getElementById('pattern-switch').classList.add('pattern-highlight');
        document.getElementById(`pattern-${method}`).classList.add('pattern-highlight');

        if (analyzeGuardConditions().triggered) {
            document.getElementById('pattern-guard').classList.add('pattern-highlight');
        }

        // Auto-remove highlights after 3 seconds
        setTimeout(() => {
            document.querySelectorAll('.pattern-highlight').forEach(row => {
                row.classList.remove('pattern-highlight');
            });
        }, 3000);
    }

    // Reset demo to initial state
    function resetDemo() {
        PaymentDemoState.selectedPaymentMethod = 'creditcard';
        PaymentDemoState.customerType = 'basic';
        PaymentDemoState.isInternational = false;

        PAYMENT_DEMO_CONFIG.orderAmount = PAYMENT_DEMO_CONFIG.originalAmount;
        updateAmountDisplays(PAYMENT_DEMO_CONFIG.originalAmount);

        document.getElementById('customer-basic').checked = true;
        document.getElementById('international-card').checked = false;

        updateSelectedPaymentMethod('creditcard');
        updatePatternMatching();
        clearLog();

        logAPIFlow('Demo Reset', 'All settings restored to defaults', 'info');
        showNotification('Demo reset to initial state', 'success');
    }

    // Show demo scenarios modal
    function showDemoScenarios() {
        const modal = new bootstrap.Modal(document.getElementById('scenariosModal'));
        modal.show();
    }

    // Show flow help
    function showFlowHelp() {
        const helpText = `
        <strong>Visual Flow Inspector Guide:</strong><br>
        🎯 Shows real-time pattern matching decisions<br>
        📊 Tracks guard condition evaluations<br>
        🔄 Displays processing flow steps<br>
        <span class="java21-pattern-tag">Java 21</span> tags highlight new language features
        `;
        showNotification(helpText, 'info');
    }

    // Run automated demo scenario
    async function runScenario(scenarioType) {
        if (PaymentDemoState.scenarioRunning) {
            showNotification('Please wait for current scenario to complete', 'warning');
            return;
        }

        PaymentDemoState.scenarioRunning = true;
        const modal = bootstrap.Modal.getInstance(document.getElementById('scenariosModal'));
        if (modal) modal.hide();

        showNotification(`Running scenario: ${getScenarioName(scenarioType)}`, 'info');

        try {
            switch (scenarioType) {
                case 'high-value-international':
                    await runHighValueInternationalScenario();
                    break;
                case 'premium-paypal':
                    await runPremiumPayPalScenario();
                    break;
                case 'large-bank-transfer':
                    await runLargeBankTransferScenario();
                    break;
                case 'all-patterns':
                    await runAllPatternsScenario();
                    break;
            }
        } catch (error) {
            console.error('Scenario error:', error);
            showNotification('Scenario encountered an error', 'danger');
        } finally {
            PaymentDemoState.scenarioRunning = false;
        }
    }

    // High-value international scenario
    async function runHighValueInternationalScenario() {
        logAPIFlow('Scenario Started', 'High-Value International Transaction', 'info');

        await delay(500);
        setAmount(1500);

        await delay(1000);
        updateSelectedPaymentMethod('creditcard');

        await delay(1000);
        const internationalToggle = document.getElementById('international-card');
        if (internationalToggle) {
            internationalToggle.checked = true;
            handleInternationalToggle({ target: internationalToggle });
        }

        await delay(1500);
        logAPIFlow('Scenario Result', 'Complex guard condition: amount > $1000 && isInternational', 'guard');
        showNotification('✅ High-value international transaction requires additional verification!', 'warning');
    }

    // Premium PayPal scenario
    async function runPremiumPayPalScenario() {
        logAPIFlow('Scenario Started', 'Premium Customer PayPal Processing', 'info');

        await delay(500);
        document.getElementById('customer-premium').checked = true;
        handleCustomerTypeChange({ target: document.getElementById('customer-premium') });

        await delay(1000);
        updateSelectedPaymentMethod('paypal');

        await delay(1500);
        logAPIFlow('Scenario Result', 'Premium customer gets expedited PayPal processing', 'success');
        showNotification('✅ Premium customer qualifies for expedited PayPal processing!', 'success');
    }

    // Large bank transfer scenario
    async function runLargeBankTransferScenario() {
        logAPIFlow('Scenario Started', 'Large Bank Transfer with Manager Approval', 'info');

        await delay(500);
        setAmount(6000);

        await delay(1000);
        updateSelectedPaymentMethod('banktransfer');

        await delay(1500);
        logAPIFlow('Scenario Result', 'Large transfer requires manager approval: amount >= $5000', 'guard');
        showNotification('✅ Large bank transfer requires manager approval!', 'warning');
    }

    // Test all patterns scenario
    async function runAllPatternsScenario() {
        logAPIFlow('Scenario Started', 'Testing All Payment Method Patterns', 'info');

        const methods = ['creditcard', 'paypal', 'banktransfer'];

        for (let i = 0; i < methods.length; i++) {
            const method = methods[i];

            await delay(1000);
            updateSelectedPaymentMethod(method);

            await delay(500);
            logAPIFlow('Pattern Tested', `${getPatternName(method)} pattern matched successfully`, 'pattern');
        }

        showNotification('✅ All payment method patterns tested successfully!', 'success');
    }

    // Clear log
    function clearLog() {
        document.getElementById('api-log').innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-mouse-pointer mb-2"></i><br>
                Select payment method and amount to see pattern matching...
            </div>
        `;
    }

    // Show notification toast
    function showNotification(message, type = 'info') {
        const container = document.getElementById('toast-container');

        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.minWidth = '300px';
        notification.style.borderRadius = '10px';
        notification.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';

        const icons = {
            'success': 'fas fa-check-circle',
            'warning': 'fas fa-exclamation-triangle',
            'danger': 'fas fa-exclamation-circle',
            'info': 'fas fa-info-circle'
        };

        notification.innerHTML = `
            <i class="${icons[type]} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        container.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, type === 'danger' ? 8000 : 5000);

        console.log(`📢 Notification (${type}): ${message}`);
    }

    // Helper functions
    function getPatternName(method) {
        const names = {
            'creditcard': 'CreditCard',
            'paypal': 'PayPal',
            'banktransfer': 'BankTransfer'
        };
        return names[method] || method;
    }

    function mapPaymentType(method) {
        const mapping = {
            'creditcard': 'CREDIT_CARD',
            'paypal': 'PAYPAL',
            'banktransfer': 'BANK_TRANSFER'
        };
        return mapping[method] || method.toUpperCase();
    }

    function getScenarioName(scenarioType) {
        const names = {
            'high-value-international': 'High-Value International Transaction',
            'premium-paypal': 'Premium Customer PayPal',
            'large-bank-transfer': 'Large Bank Transfer',
            'all-patterns': 'Test All Patterns'
        };
        return names[scenarioType] || scenarioType;
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Export demo functions for testing
    window.PaymentProcessingDemo = {
        config: PAYMENT_DEMO_CONFIG,
        state: PaymentDemoState,
        processPayment,
        clearLog,
        setAmount,
        resetDemo,
        runScenario,
        showDemoScenarios
    };

    console.log('🚀 Enhanced Payment Processing Demo with Rich UI loaded successfully');
    console.log('✅ Features: Rich Visual Flow Inspector, Automated Scenarios, Enhanced Styling');
</script>
</body>
</html>